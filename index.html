<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>City Car Services - Invoice</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #0b5fb4; --accent: #ffda00; }
        body { font-family: 'Plus Jakarta Sans', 'Noto Sans Devanagari', sans-serif; background: #f1f5f9; padding: 0; color: #000; }
        
        .a4-wrapper { width: 210mm; min-height: 297mm; margin: 0 auto; background: #fff; }
        .header-banner { background: var(--primary); color: #fff; }
        .top-info { background: rgba(0,0,0,0.2); padding: 4px 20px; font-size: 11px; display: flex; justify-content: space-between; font-weight: 600; }
        .main-header { display: flex; align-items: center; padding: 10px 25px; text-align: center; gap: 15px; }
        
        .logo-box { width: 90px; height: 70px; display: flex; align-items: center; justify-content: center; }
        .logo-box img { max-width: 100%; max-height: 100%; object-fit: contain; }

        .brand-text h1 { font-size: 34px; font-weight: 800; margin: 0; line-height: 1; }
        .marathi-brand { font-size: 20px; font-weight: 700; color: var(--accent); }
        .address-bar { font-size: 11px; font-weight: 700; margin-top: 2px; }

        .content-area { padding: 15px 30px; }
        .customer-info-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
        
        .marathi-label { font-size: 14px; color: #000; font-weight: 800; margin-bottom: 0px; display: block; }
        .english-sub { font-size: 11px; color: #000; font-weight: 700; text-transform: uppercase; }
        .form-control-static { border: 1.5px solid #000; border-radius: 4px; padding: 4px 8px; font-size: 14px; font-weight: 800; width: 100%; height: 32px; }

        .table-custom { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .table-custom thead { background: #000; color: #fff; }
        .table-custom th { padding: 6px; font-size: 11px; border: 1px solid #000; }
        .table-custom td { padding: 4px 6px; border: 1px solid #000; font-weight: 800; vertical-align: middle; font-size: 13px; }
        
        .item-input { border: none; background: transparent; width: 100%; padding: 2px; font-weight: 800; color: #000; outline: none; }

        .total-box { background: #000; color: white; padding: 12px; border-radius: 8px; width: 300px; margin-left: auto; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 13px; }
        
        .gst-toggle-group { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; justify-content: flex-end; }
        .btn-toggle { font-size: 11px; padding: 3px 12px; font-weight: 800; border-radius: 20px; }

        .terms-box { border: 1.5px solid #000; padding: 8px; border-radius: 6px; font-size: 10px; font-weight: 700; line-height: 1.2; }

        #previewOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center; padding: 20px; }
        .preview-card { background:#fff; width:100%; max-width:400px; padding:20px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .msg-content { background:#f0f7ff; padding:15px; border-radius:8px; white-space: pre-wrap; font-size: 12px; border: 1px solid #cce4ff; color: #000; font-family: 'Courier New', Courier, monospace; max-height: 300px; overflow-y: auto; }

        @media print { .no-print { display: none !important; } .a4-wrapper { border: none; margin: 0; padding: 0; } }
        .action-bar { position: sticky; top: 0; z-index: 1000; background: #fff; padding: 10px; border-bottom: 2px solid #000; display: flex; justify-content: center; gap: 15px; }
    </style>
</head>
<body>

<div class="action-bar no-print">
    <button class="btn btn-dark fw-bold" onclick="location.reload()"><i class="fa-solid fa-sync me-1"></i> NEW</button>
    <button class="btn btn-primary fw-bold" onclick="finalizeAndSave()"><i class="fa-solid fa-file-pdf me-1"></i> PDF</button>
    <button class="btn btn-success fw-bold" onclick="showWhatsAppPreview()"><i class="fa-brands fa-whatsapp me-1"></i> WHATSAPP</button>
</div>

<div class="a4-wrapper" id="printArea">
    <div class="header-banner">
        <div class="top-info">
            <span>üìû 8698228740 / 9130172939</span>
            <span class="badge bg-danger">BRANCH-2 / ‡§∂‡§æ‡§ñ‡§æ-‡•®</span>
            <span>Pune, MH</span>
        </div>
        <div class="main-header">
            <div class="logo-box"><img src="https://raw.githubusercontent.com/Studnit/carservice/main/image.png"></div>
            <div class="brand-text">
                <h1>CITY CAR SERVICES</h1>
                <span class="marathi-brand">‡§∏‡§ø‡§ü‡•Ä ‡§ï‡§æ‡§∞ ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§ø‡§∏‡•á‡§∏</span>
                <div class="address-bar">Radha Chowk, Mahalunge Road, Baner, Pune - 411045</div>
            </div>
            <div class="logo-box"><img src="https://raw.githubusercontent.com/Studnit/carservice/main/image.png"></div>
        </div>
    </div>

    <div class="content-area">
        <div class="d-flex justify-content-between align-items-end mb-2">
            <div>
                <h5 class="mb-0 fw-bold text-primary" id="billTypeLabel">TAX INVOICE / ‡§¨‡§ø‡§≤</h5>
                <div class="fw-bold small" id="currentDate"></div>
            </div>
            <div class="text-end">
                <span class="english-sub">Invoice No</span>
                <div class="h5 fw-bold mb-0" id="invoiceIdDisplay">#CCS-1001</div>
            </div>
        </div>

        <div class="customer-info-grid">
            <div><label class="marathi-label">‡§®‡§æ‡§µ <span class="english-sub">(Name)</span></label><input type="text" class="form-control-static" id="custName"></div>
            <div><label class="marathi-label">‡§ó‡§æ‡§°‡•Ä ‡§ï‡•ç‡§∞. <span class="english-sub">(Veh No)</span></label><input type="text" class="form-control-static text-uppercase" id="vehNo"></div>
            <div><label class="marathi-label">‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï <span class="english-sub">(Mobile)</span></label><input type="number" class="form-control-static" id="whatsapp"></div>
        </div>

        <table class="table-custom">
            <thead>
                <tr>
                    <th width="5%">#</th>
                    <th width="55%">Service Description / ‡§§‡§™‡§∂‡•Ä‡§≤</th>
                    <th width="8%">Qty</th>
                    <th width="12%">Rate</th>
                    <th width="20%" class="text-end">Total</th>
                </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
        </table>

        <div class="no-print mb-2"><button class="btn btn-sm btn-outline-dark fw-bold" onclick="addRow()">+ Add Service</button></div>

        <div class="row">
            <div class="col-7">
                <div class="terms-box">
                    <p class="fw-bold mb-1 border-bottom border-dark">Terms & Conditions:</p>
                    ‚Ä¢ Warranty as per manufacturer terms.<br>
                    ‚Ä¢ All disputes subject to Pune jurisdiction.<br>
                    ‚Ä¢ Payment must be cleared before delivery.
                </div>
            </div>
            <div class="col-5">
                <div class="gst-toggle-group no-print">
                    <span class="small fw-bold">GST:</span>
                    <button id="gstBtnOn" class="btn btn-toggle btn-success" onclick="setGST(true)">ON</button>
                    <button id="gstBtnOff" class="btn btn-toggle btn-outline-secondary" onclick="setGST(false)">OFF</button>
                </div>
                <div class="total-box">
                    <div class="total-row"><span>Sub-Total</span><span id="subtotalDisplay">‚Çπ0.00</span></div>
                    <div id="gstRow" class="total-row pb-1 border-bottom border-secondary">
                        <span>GST (18%)</span>
                        <span id="taxDisplay">‚Çπ0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="fw-bold">GRAND TOTAL</span>
                        <span class="h5 fw-bold mb-0" id="grandTotalDisplay" style="color:var(--accent)">‚Çπ0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px;" class="d-flex justify-content-between text-center fw-bold">
            <div style="width: 140px; border-top: 1.5px solid #000; padding-top: 2px; font-size: 12px;">Customer Sign</div>
            <div style="width: 170px; border-top: 1.5px solid #000; padding-top: 2px; font-size: 12px;">CITY CAR SERVICES</div>
        </div>
    </div>
</div>

<div id="previewOverlay">
    <div class="preview-card">
        <h6 class="fw-bold border-bottom pb-2 mb-3">WhatsApp Preview</h6>
        <div class="msg-content mb-3" id="msgPreviewText"></div>
        <div class="d-flex gap-2">
            <button class="btn btn-success flex-grow-1 fw-bold" onclick="confirmAndSend()"><i class="fa-brands fa-whatsapp me-1"></i> SEND NOW</button>
            <button class="btn btn-light border fw-bold" onclick="closePreview()">BACK</button>
        </div>
    </div>
</div>

<datalist id="serviceList">
    <option value="Full Service (‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§ø‡§∏‡§ø‡§Ç‡§ó)">
    <option value="Engine Oil Change (‡§á‡§Ç‡§ú‡§ø‡§® ‡§ë‡§à‡§≤ ‡§¨‡§¶‡§≤‡§£‡•á)">
    <option value="Brake Pad Replacement (‡§¨‡•ç‡§∞‡•á‡§ï ‡§™‡•Ö‡§° ‡§¨‡§¶‡§≤‡§£‡•á)">
    <option value="Wheel Alignment (‡§µ‡•ç‡§π‡•Ä‡§≤ ‡§Ö‡§≤‡§æ‡§á‡§®‡§Æ‡•á‡§Ç‡§ü)">
    <option value="AC Gas Refill (‡§è‡§∏‡•Ä ‡§ó‡•Ö‡§∏ ‡§∞‡§ø‡§´‡§ø‡§≤)">
    <option value="Washing & Cleaning (‡§µ‡•â‡§∂‡§ø‡§Ç‡§ó ‡§Ü‡§£‡§ø ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§Ç‡§ó)">
</datalist>

<script>
    let lastId = parseInt(localStorage.getItem('ccs_id_v4')) || 1001;
    let isGSTEnabled = true;
    let finalWhatsAppURL = "";

    function updateHeader() {
        document.getElementById("invoiceIdDisplay").innerText = "#CCS-" + lastId;
        document.getElementById("currentDate").innerText = new Date().toLocaleString('en-GB', { day:'2-digit', month:'short', year:'numeric'});
    }

    function addRow() {
        const tb = document.getElementById("itemsBody");
        const sr = tb.children.length + 1;
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td class="text-center">${sr}</td>
            <td><input class="item-input" list="serviceList" placeholder="Enter service details..."></td>
            <td><input type="number" class="item-input text-center" value="1" oninput="calculate()"></td>
            <td><input type="number" class="item-input text-end" value="0" oninput="calculate()"></td>
            <td class="text-end">‚Çπ0.00</td>
        `;
        tb.appendChild(tr);
    }

    function setGST(status) {
        isGSTEnabled = status;
        document.getElementById("gstRow").style.display = status ? "flex" : "none";
        document.getElementById("billTypeLabel").innerText = status ? "TAX INVOICE / ‡§¨‡§ø‡§≤" : "ESTIMATE / ‡§ï‡§ö‡•ç‡§ö‡§æ ‡§¨‡§ø‡§≤";
        
        document.getElementById("gstBtnOn").className = status ? "btn btn-toggle btn-success" : "btn btn-toggle btn-outline-secondary";
        document.getElementById("gstBtnOff").className = status ? "btn btn-toggle btn-outline-secondary" : "btn btn-toggle btn-danger";
        
        calculate();
    }

    function calculate() {
        let sub = 0;
        document.querySelectorAll("#itemsBody tr").forEach(row => {
            const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const rate = parseFloat(row.cells[3].querySelector('input').value) || 0;
            const total = qty * rate;
            row.cells[4].innerText = "‚Çπ" + total.toLocaleString('en-IN', {minimumFractionDigits: 2});
            sub += total;
        });
        const gst = isGSTEnabled ? (sub * 0.18) : 0;
        const grand = Math.round(sub + gst);
        document.getElementById("subtotalDisplay").innerText = "‚Çπ" + sub.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById("taxDisplay").innerText = "‚Çπ" + gst.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById("grandTotalDisplay").innerText = "‚Çπ" + grand.toLocaleString('en-IN');
    }

    function showWhatsAppPreview() {
        const phone = document.getElementById("whatsapp").value;
        const name = document.getElementById("custName").value || "Customer";
        const veh = document.getElementById("vehNo").value || "Vehicle";
        const total = document.getElementById("grandTotalDisplay").innerText;
        const subtotal = document.getElementById("subtotalDisplay").innerText;
        const gst = document.getElementById("taxDisplay").innerText;
        const invId = document.getElementById("invoiceIdDisplay").innerText;
        const date = document.getElementById("currentDate").innerText;

        if(!phone) { alert("Please enter mobile number first!"); return; }

        let itemsText = "";
        let displayItemsText = "";
        document.querySelectorAll("#itemsBody tr").forEach(row => {
            const desc = row.cells[1].querySelector('input').value;
            const price = row.cells[4].innerText;
            if(desc && desc.trim() !== "") {
                itemsText += `‚Ä¢ ${desc} - ${price}%0A`;
                displayItemsText += `‚Ä¢ ${desc} - ${price}\n`;
            }
        });

        const type = isGSTEnabled ? "TAX INVOICE" : "ESTIMATE";
        const msgHeader = `üßæ *CITY CAR SERVICES ‚Äì ${type}*`;
        const msgBody = `%0A%0A*Bill No:* ${invId}%0A*Date:* ${date}%0A%0A*Customer:* ${name}%0A*Vehicle:* ${veh}%0A%0A--------------------------------%0A*Details:*%0A${itemsText}%0A*Sub Total:* ${subtotal}${isGSTEnabled ? '%0A*GST (18%):* ' + gst : ''}%0A--------------------------------%0A*GRAND TOTAL: ${total}*%0A--------------------------------%0A%0AThank you for choosing us! üöó`;

        finalWhatsAppURL = `https://wa.me/91${phone}?text=${msgHeader}${msgBody}`;
        
        document.getElementById("msgPreviewText").innerText = `CITY CAR SERVICES\n\nBill No: ${invId}\nCustomer: ${name}\nVehicle: ${veh}\n\nDetails:\n${displayItemsText || 'No items entered'}\n\nTotal: ${total}`;
        document.getElementById("previewOverlay").style.display = "flex";
    }

    function closePreview() { document.getElementById("previewOverlay").style.display = "none"; }
    function confirmAndSend() { window.open(finalWhatsAppURL, '_blank'); closePreview(); }

    function finalizeAndSave() {
        const element = document.getElementById("printArea");
        html2pdf().set({
            margin: 0, filename: `CityCar_Bill_${lastId}.pdf`,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).from(element).save().then(() => {
            lastId++;
            localStorage.setItem('ccs_id_v4', lastId);
            updateHeader();
        });
    }

    updateHeader();
    for(let i=0; i<1; i++) addRow();
</script>
</body>
</html>
